#
# REFs:
# - https://github.com/nicolargo/varnish-nginx-wordpress/blob/master/nginx/nginx.conf
# - https://github.com/VisiStruct/LEMH-Server/blob/master/nginx/nginx.conf
#

user <%= @user %>;
# Number of cpu cores (grep processor /proc/cpuinfo | wc -l)
worker_processes 1;
# number of files openned for each connection/client
worker_rlimit_nofile 2048;
timer_resolution 100ms;

# JIT Regular expression parser. Need nginx built with that.
# pcre_jit on;
pid /var/run/nginx.pid;

error_log  /var/log/nginx/error.log warn;

events {
  # max_clients = worker_processes * worker_connections
  worker_connections 1024;
  accept_mutex on;
  accept_mutex_delay 200ms;
  # Only for Linux 2.6 or >
  use epoll;
  # Accept as many connections as possible
  multi_accept on;
}

http {
  # FastCGI Cache
  include fastcgi_cache.conf;

  index index.html index.php index.htm;
  charset utf-8;

  # Log format
  log_format main '$remote_addr - $remote_user [$time_local] $request '
                  '"$status" $body_bytes_sent "$http_referer" '
                  '"$http_user_agent" "$http_x_forwarded_for" "gzip_ratio" '
                  '"$connection" "$connection_requests" "$request_time"';
  # Logging files
  access_log                    /var/log/nginx/access.log;
  error_log                     /var/log/nginx/error.log;

  # Mime types
  include                       /etc/nginx/mime.types;
  default_type                  application/octet-stream;


  # Some tweeks...
  sendfile                      on;
  sendfile_max_chunk            512k;
  tcp_nodelay                   on;
  tcp_nopush                    on;
  # Hide the Nginx version number
  server_tokens                 off;

  # Timeouts
  keepalive_timeout             30s;
  keepalive_requests            500;
  lingering_time                20s;
  lingering_timeout             5s;
  keepalive_disable             msie6;

  ##
  # Gzip Settings
  gzip                          on;
  gzip_vary                     on;
  gzip_disable                  "MSIE [1-6].(?!.*SV1)";
  gzip_static                   on;
  gzip_min_length               1400;
  gzip_buffers                  32 8k;
  gzip_http_version             1.0;
  gzip_comp_level               5;
  gzip_proxied                  any;
  gzip_types text/plain text/css text/xml application/javascript application/x-javascript application/xml application/xml+rss application/ecmascript application/json image/svg+xml;

  client_body_buffer_size       256k;
  client_body_in_file_only      off;
  client_body_timeout           60s;
  client_header_buffer_size     64k;
  client_header_timeout         10s;
  client_max_body_size          50M;
  connection_pool_size          512;
  directio                      4m;
  ignore_invalid_headers        on;
  large_client_header_buffers   8 64k;
  output_buffers                8 256k;
  postpone_output               1460;
  proxy_temp_path               /tmp/nginx_proxy/;
  request_pool_size             32k;
  reset_timedout_connection     on;
  send_timeout                  30s;
  types_hash_max_size           2048;
  server_names_hash_bucket_size 64;

  open_file_cache max=50000 inactive=60s;
  open_file_cache_valid 120s;
  open_file_cache_min_uses 2;
  open_file_cache_errors off;
  open_log_file_cache max=10000 inactive=30s min_uses=2;

  # Rate limiting
  limit_req_zone $binary_remote_addr zone=wplogin:16m rate=30r/m;

  map $scheme $server_https {
    default off;
    https on;
  }

  <% if @real_ip_from %>
    # Put the Ip of your varnish/proxy here
    set_real_ip_from  <%= @real_ip_from %>;

    # Put the Header that your varnish/proxy set
    real_ip_header    X-Forwarded-For;
  <% end %>

  ##
  # Virtual Host Configs
  ##

  include /etc/nginx/conf.d/*.conf;
  include /etc/nginx/sites-enabled/*;
}
